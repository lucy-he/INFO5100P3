<!DOCTYPE html>
<html>
<head>
	<title>wheel-cal</title>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<style>
    *.unselectable {
       -moz-user-select: -moz-none;
       -khtml-user-select: none;
       -webkit-user-select: none;

       /*
         Introduced in IE 10.
         See http://ie.microsoft.com/testdrive/HTML5/msUserSelect/
       */
       -ms-user-select: none;
       user-select: none;
    }
    text{
        font-family:Helvetica, Arial, sans-serif;
        font-size:11px;
        pointer-events:none;
    }
    #chart{
        position:absolute;
        width:500px;
        height:500px;
    }
    #question{
        position: absolute;
        width:400px;
        height:500px;
        top:0;
        left:520px;
    }
    #question h1{
        font-size: 50px;
        font-weight: bold;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        position: absolute;
        padding: 0;
        margin: 0;
        top:50%;
        -webkit-transform:translate(0,-50%);
                transform:translate(0,-50%);
    }
    .spin-button:focus, .spin-button:active{
        outline: none !important;
    }
    #selection {
        background-color:red;
        height: 100px;
        width: 100%;
    }
    #svg-cal {
        border: solid black 1px;
        margin-top: 600px;
    }
	</style>
</head>
<body>
<div id="selection"></div>
<div id="question"><h1></h1></div>
<div id="chart"></div>
<div id="calendar"></div>
<script>
    var data;
    var change;
    var sliceArr;
    var arcPath;

    var heartDis = [];
    var cancer = [];
    var respDis = [];
    var accident = [];
    var stroke = [];
    var alzheimer = [];
    var diabetes = [];
    var flu = [];

    d3.csv("DeathRecordsFinal.csv", function(deaths) {

        deaths.forEach(function(d) {
            if(d.Icd10Code[0] == "I" 
                && (parseInt(d.Icd10Code.slice(1,3)) >= 1)
                && (parseInt(d.Icd10Code.slice(1,3)) <= 52) 
                ){
                heartDis.push(d);
            }
            else if(d.Icd10Code[0] == "C" 
                && (parseInt(d.Icd10Code.slice(1,3)) >= 0)
                && (parseInt(d.Icd10Code.slice(1,3)) <= 97) 
                ){
                cancer.push(d);
            }
            else if(d.Icd10Code[0] == "J" 
                && (parseInt(d.Icd10Code.slice(1,3)) >= 40)
                && (parseInt(d.Icd10Code.slice(1,3)) <= 47) 
                ){
                respDis.push(d);
            }
            else if((d.Icd10Code[0] == "V") || (d.Icd10Code[0] == "W") || (d.Icd10Code[0] == "X" && (parseInt(d.Icd10Code.slice(1,3)) <= 59) )
                ){
                accident.push(d);
            }
            else if(d.Icd10Code[0] == "I" 
                && (parseInt(d.Icd10Code.slice(1,3)) >= 60)
                && (parseInt(d.Icd10Code.slice(1,3)) <= 69) 
                ){
                stroke.push(d);
            }
            else if(d.Icd10Code[0] == "G" 
                && (parseInt(d.Icd10Code.slice(1,3)) == 30) 
                ){
                alzheimer.push(d);
            }
            else if(d.Icd10Code[0] == "E" 
                && (parseInt(d.Icd10Code.slice(1,3)) >= 10)
                && (parseInt(d.Icd10Code.slice(1,3)) <= 14) 
                ){
                diabetes.push(d);
            }
            else if(d.Icd10Code[0] == "J" 
                && (parseInt(d.Icd10Code.slice(1,3)) >= 9)
                && (parseInt(d.Icd10Code.slice(1,3)) <= 18) 
                ){
                flu.push(d);
            }
        });
        
        data = [
            {"label":"heart disease",  "value":heartDis.length},
            {"label":"cancer",  "value":cancer.length},
            {"label":"respiratory disease",  "value":respDis.length},
            {"label":"accidents",  "value":accident.length},
            {"label":"stroke",  "value":stroke.length},
            {"label":"Alzheimer's disease",  "value":alzheimer.length},
            {"label":"diabetes",  "value":diabetes.length},
            {"label":"influenza and pneumonia",  "value":flu.length}
        ];

        function updateSliceArr() {        
            //populate slice array according to data
            sliceArr = [];
            for(var i = 0; i < data.length; i++){
                for(var j = 0; j < data[i].value; j++){
                    sliceArr.push(data[i].label);
                }
            }
            sliceArr.reverse();
        }
        updateSliceArr();

        var padding = {top:20, right:40, bottom:20, left:0},
            w = parseInt(d3.select('#chart').style('width'), 10)
      		, w = w - padding.left - padding.right,
            h = parseInt(d3.select('#chart').style('height'), 10)
      		,h = h - padding.top - padding.bottom,
            r = Math.min(w, h)/2,
            picked = 0,
            color = d3.scale.category20();
            
        // declare an arc generator function
        var arc = d3.svg.arc()
            .outerRadius(r)
            .innerRadius(60); //TODO donut

        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d){
                return d.value;
            });

        var svg = d3.select('#chart').append("svg")
            .attr("width",  '100%')
            .attr("height",'100%')
            .attr('viewBox','0 20 '+Math.min(w,h) +' '+Math.min(w,h) )
            .attr('preserveAspectRatio','xMinYMin');

        var container = svg.append("g")
            .attr("transform", "translate(" + (w/2 + padding.left) + "," + (h/2 + padding.top) + ")");

        // select paths, use arc generator to draw
        var arcs = container.selectAll("g.slice")
            .data(pie(data))
            .enter()
            .append("g")
            .attr("class", "slice");
            
        arcPath = arcs.selectAll("path")
            .data(pie(data))
            .enter()
            .append("path");

        arcPath
            .attr("fill", function(d, i){
                return color(i); 
            })
            .attr("d", arc)
            .each(function (d) {
                this._current = d;
            });
            
        // add the text
        var arcText = arcs.selectAll("text")
            .data(pie(data))
            .enter()
            .append("text");

        arcText
            .attr("transform", function(d){
                d.innerRadius = 0;
                d.outerRadius = r;
                d.angle = (d.startAngle + d.endAngle)/2;
                return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")translate(" + (d.outerRadius -10) +")";
            })
            .attr("text-anchor", "end")
            .attr("class","unselectable")
            .text( function(d, i) {
                return data[i].label;
            });


        //make arrow
        svg.append("g")
            .attr("transform", "translate(" + (w/2 + padding.left) + "," + 0 + ") rotate(270) ")
            .append("path")
            .attr("d", "M-" + (r*.15) + ",0L0," + (r*.05) + "L0,-" + (r*.05) + "Z")
            .style({"fill":"black"});
        
        var heartDisSel = heartDis;
        var cancerSel = cancer;
        var respDisSel = respDis;
        var accidentSel = accident;
        var strokeSel = stroke;
        var alzheimerSel = alzheimer;
        var diabetesSel = diabetes;
        var fluSel = flu;

        //TODO: add attributes
        change = function(sex) {

            heartDisSel = [];
            cancerSel = [];
            respDisSel = [];
            accidentSel = [];
            strokeSel = [];
            alzheimerSel = [];
            diabetesSel = [];
            fluSel = [];

            data[0].value = 0;
            data[1].value = 0;
            data[2].value = 0;
            data[3].value = 0;
            data[4].value = 0;
            data[5].value = 0;
            data[6].value = 0;
            data[7].value = 0;

            heartDis.forEach(function(d) {
                if(d.Sex == sex || sex == null) {
                    data[0].value += 1;
                    heartDisSel.push(d);
                }
            });
            cancer.forEach(function(d) {
                if(d.Sex == sex || sex == null) {
                    data[1].value += 1;
                    cancerSel.push(d);
                }
            });
            respDis.forEach(function(d) {
                if(d.Sex == sex || sex == null) {
                    data[2].value += 1;
                    respDisSel.push(d);
                }
            });
            accident.forEach(function(d) {
                if(d.Sex == sex || sex == null) {
                    data[3].value += 1;
                    accidentSel.push(d);
                }
            });
            stroke.forEach(function(d) {
                if(d.Sex == sex || sex == null) {
                    data[4].value += 1;
                    strokeSel.push(d);
                }
            });
            alzheimer.forEach(function(d) {
                if(d.Sex == sex || sex == null) {
                    data[5].value += 1;
                    alzheimerSel.push(d);
                }
            });
            diabetes.forEach(function(d) {
                if(d.Sex == sex || sex == null) {
                    data[6].value += 1;
                    diabetesSel.push(d);
                }
            });
            flu.forEach(function(d) {
                if(d.Sex == sex || sex == null) {
                    data[7].value += 1;
                    fluSel.push(d);
                }
            });

            arcs.data(pie(data));
            arcPath.data(pie(data));
            arcPath.transition().attrTween("d", arcTween);
            arcText.data(pie(data));
            arcText.transition().attr("transform", function(d){
                d.innerRadius = 0;
                d.outerRadius = r;
                d.angle = (d.startAngle + d.endAngle)/2;
                return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")translate(" + (d.outerRadius -10) +")";
            })
            updateSliceArr();
        };


        function arcTween(a) {
            var i = d3.interpolate(this._current, a);
            this._current = i(0);
            return function(t) {
                return arc(i(t));
            }
        }

        var isDown = false;
        var lastX = w / 2;
        var lastY = h / 2;
        var curAngle = 0;
        var finishAngle = 0;
        var angleDeg = 0;
        
        function dragInit(x,y){
            console.log("dragInit");
            isDown = true;
            curAngle = Math.atan2(y, x);
            if (curAngle < 0) {
                curAngle += 2 * Math.PI;
            }
            curAngle = curAngle * 180 / Math.PI;
        }
        function dragCalc(x,y){
            if (isDown) {
                console.log("dragCalc");
                angleDeg = Math.atan2(y, x);
                if (angleDeg < 0) angleDeg += 2 * Math.PI;
                angleDeg = angleDeg * 180 / Math.PI;
                angleDeg = angleDeg - curAngle + finishAngle;
                if (angleDeg < 0) angleDeg += 360; 
                
                //spin image
                container.attr("transform", "translate(" + (w / 2 + padding.left) + "," + (h / 2 + padding.top) + ") rotate(" + angleDeg + "," + 0 + "," + 0 + ")");
                // console.log(angleDeg);

                //populate question TODO
                picked = Math.floor(((angleDeg%360)/360)*sliceArr.length);
                d3.select("#question h1")
                    .text(sliceArr[picked]);

                updateCalendar(sliceArr[picked]);
            }
        }
        function dragEnd(){
            console.log("dragEnd");
            finishAngle = angleDeg%360;
            oldrotation = angleDeg%360;
            // spin(); //TODO based on momentum
            console.log(finishAngle); //TODO: same variable!
            isDown = false;
        }

        container.on("mousedown", function(d) {
            var thisX = lastX - d3.event.x;
            var thisY = lastY - d3.event.y;
            dragInit(thisX, thisY);
        });
        container.on("mousemove", function(d) {
            var thisX = lastX - d3.event.x;
            var thisY = lastY - d3.event.y;
            dragCalc(thisX, thisY);
        });
        container.on("mouseup", function(d) {
            dragEnd();
        });

        container.on("touchstart", function(d) {
            var thisX = lastX - parseInt(d3.event.touches[0].clientX);
            var thisY = lastY - parseInt(d3.event.touches[0].clientY);
            dragInit(thisX, thisY);
        });
        container.on("touchmove", function(d) {
            var thisX = lastX - parseInt(d3.event.touches[0].clientX);
            var thisY = lastY - parseInt(d3.event.touches[0].clientY);
            dragCalc(thisX, thisY);
        });
        container.on("touchend", function(d) {
            dragEnd();
        });

        
        //draw spin circle
        var spinButt = container.append("circle")
            .attr("cx", 0)
            .attr("cy", 0)
            .attr("class", "spin-button")
            .attr("r", 60)
            .style({"fill":"white","cursor":"pointer"});
        spinButt.on("click", spin); //TODO: FIX THE DRAG AFTER A SPIN

        //spin text
        var spinText = svg.append("text")
            .attr("x", w/2 + padding.left)
            .attr("y", h/2 + padding.top)
            .attr("text-anchor", "middle")
            .text("SPIN")
            .attr("class","unselectable")
            .style({"font-weight":"bold", "font-size":"30px"});

        var oldrotation = 0;
        function spin(d){
            angleDeg = Math.floor(Math.random()*360)+720;

            container.transition().duration(3000)
                .attrTween("transform", rotTween)
                .each("end", function(){
                    oldrotation = angleDeg;
                    //populate question TODO
                    picked = Math.floor((((angleDeg)%360)/360)*sliceArr.length);
                    d3.select("#question h1")
                        .text(sliceArr[picked]);
                    updateCalendar(sliceArr[picked]);
                });
            finishAngle = (angleDeg)%360;
        }

        function rotTween(to) {
            var i = d3.interpolate(oldrotation % 360, (angleDeg));
            return function(t) {
                return "translate(" + (w / 2 + padding.left) + "," + (h / 2 + padding.top) + ") rotate(" + i(t) + ")";
                };
        }

        spin();
        
        function updateCalendar(deathCause) {
            // calendar display

            if (d3.select('#svg-cal')) {
                d3.select('#svg-cal').remove();
            }

            var calWidth = 300;
            var calHeight = calWidth;
            var calPaddingHor = calWidth * 0.05;
            var calPaddingVer = calHeight * 0.1;

            var barWidth = (calWidth - 2 * calPaddingHor) / 7;
            var barHeight = calHeight * 0.6;
            var barPadding = barWidth * 0.1;

            var svgCal = d3.select('#calendar').append("svg")
                .attr("id", "svg-cal")
                .attr("width",  calWidth)
                .attr("height", calHeight)
                .style({"padding-top": calPaddingVer});

            // data for selected death cause

            var deathMonthData = {};
            for (var m = 1; m <= 12; m++) {
                deathMonthData[m] = {};
                for (var d = 1; d <= 7; d++) {
                    deathMonthData[m][d] = [];
                }
            }

            var deathCauseData;
            if(deathCause == 'heart disease'){
                deathCauseData = heartDisSel;
            } else if(deathCause == 'cancer'){
                deathCauseData = cancerSel;
            } else if(deathCause == 'respiratory disease'){
                deathCauseData = respDisSel;
            } else if(deathCause == 'accidents'){
                deathCauseData = accidentSel;
            } else if(deathCause == 'stroke'){
                deathCauseData = strokeSel;
            } else if(deathCause == "Alzheimer's disease"){
                deathCauseData = alzheimerSel;
            } else if(deathCause == 'diabetes'){
                deathCauseData = diabetesSel;
            } else if(deathCause == 'influenza and pneumonia'){
                deathCauseData = fluSel;
            }

            deathCauseData.forEach(function(d){
                deathMonthData[d.MonthOfDeath][d.DayOfWeekOfDeath].push(d);
            });

            // counts for selected death cause

            var deathMonth = 1;
            var deathMonthCount = 0;

            for (var m = 1; m <= 12; m++) {
                var thisMonthCount = 0;
                for (var d = 1; d <= 7; d++) {
                    thisMonthCount += deathMonthData[m][d].length;
                }
                if (deathMonthCount < thisMonthCount) {
                    deathMonthCount = thisMonthCount;
                    deathMonth = m;
                }
            }

            var dayCountMin = deathMonthData[deathMonth][1].length;
            var dayCountMax = deathMonthData[deathMonth][1].length;

            for (var d = 2; d <= 7; d++) {
                var dayCount = deathMonthData[deathMonth][d].length
                if (dayCountMin > dayCount) {
                    dayCountMin = dayCount;
                } else if (dayCountMax < dayCount) {
                    dayCountMax = dayCount;
                }
            }

            // month display

            var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            var deathMonthLabel = months[deathMonth-1];

            svgCal.append("text")
                .attr("x", calWidth/2)
                .attr("y", calPaddingVer)
                .attr("text-anchor", "middle")
                .text(deathMonthLabel)
                .style({"font-size": calHeight * 0.13});

            // day display

            var days = ["S","M","T","W","T","F","S"];

            var opacityScale = d3.scale.linear().domain([dayCountMin,dayCountMax]).range([0.1,1]);

            for (var d = 0; d <= 6; d++) {
                svgCal.append("text")
                    .attr("x", calPaddingHor + barWidth * d + barWidth / 2)
                    .attr("y", calPaddingVer * 2.65)
                    .attr("text-anchor", "middle")
                    .text(days[d])
                    .style({"font-size": calHeight * 0.08});

                svgCal.append("rect")
                    .attr("height", barHeight)
                    .attr("width", barWidth - 2 * barPadding)
                    .attr("x", calPaddingHor + barPadding + barWidth * d)
                    .attr("y", calHeight - calPaddingVer - barHeight)
                    .style("fill", "#660000")
                    .style("fill-opacity", opacityScale(deathMonthData[deathMonth][d+1].length));
            }
        }
    });
</script>
</body>
</html>